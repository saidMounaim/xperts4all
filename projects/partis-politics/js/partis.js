var data = [
    { 
      "anneeD": "1963",
      "anneeDebut": "17/05/1963",
      "anneeFin": "12/08/1970",
      "totalSieges" : "144",
      "chef" : "Bahnini",
      "chefParty" : "FDIC",
      "resultat": {
        "FDIC": "69",
        "PI": "41",
        "UNFP": "28",
        "Independent": "6",
        "AUTRE": "0"
      }
    },
    {
      "anneeD": "1970",
      "anneeDebut": "12/08/1970",
      "anneeFin": "03/06/1977",
      "totalSieges" : "240",
      "chef" : "Lamrani",
      "chefParty" : "Independent",
      "resultat": {
        "Independent": "169",
        "MP": "60",
        "PI": "8",
        "PDC": "2",
        "UNFP": "1",
        "AUTRE": "0"
      }
    },
    {
      "anneeD": "1977",
      "anneeDebut": "03/06/1977",
      "anneeFin": "14/09/1984",
      "totalSieges" : "264",
      "chef" : "Osman",
      "chefParty" : "RNI",
      "resultat": {
        "Independent": "141",
        "PI": "51",
        "MP": "44",
        "USFP": "15",
        "UMT": "7",
        "MPDC": "3",
        "PA": "2",
        "PPS": "1",
        "AUTRE": "0"
      }
    },
    {
      "anneeD": "1984",
      "anneeDebut": "14/09/1984",
      "anneeFin": "25/06/1993",
      "totalSieges" : "306",
      "chef" : "Lamrani",
      "chefParty" : "Independent",
      "resultat": {
        "UC": "83",
        "RNI": "61",
        "MP": "47",
        "PI": "41",
        "USFP": "36",
        "PND": "24",
        "UMT": "5",
        "CDT": "3",
        "UGTM": "2",
        "PPS": "2",
        "OADP": "1",
        "Independent": "1",
        "AUTRE": "0"
      }
    },
    {
      "anneeD": "1993",
      "anneeDebut": "25/06/1993",
      "anneeFin": "14/11/1997",
      "totalSieges" : "333",
      "chef" : "Lamrani",
      "chefParty" : "Independent",
      "resultat": {
        "UC": "54",
        "USFP": "52",
        "PI": "52",
        "MP": "51",
        "RNI": "41",
        "MNP": "25",
        "PND": "24",
        "PPS": "10",
        "PDI": "9",
        "CDT": "4",
        "Independent": "4",
        "UMT": "3",
        "PA": "2",
        "OADP": "2",
        "AUTRE": "0"
      }
    },
    {
      "anneeD": "1997",
      "anneeDebut": "14/11/1997",
      "anneeFin": "27/09/2002",
      "totalSieges" : "325",
      "chef" : "Youssoufi",
      "chefParty" : "USFP",
      "resultat": {
        "USFP": "57",
        "UC": "50",
        "RNI": "46",
        "MP": "40",
        "PI": "32",
        "MDS": "32",
        "MNP": "19",
        "PND": "10",
        "MPCD": "9",
        "FED": "9",
        "PPS": "9",
        "PSD": "5",
        "OADP": "4",
        "PA": "2",
        "PDI": "1",
        "AUTRE": "0",
        "Independent": "0"
      }
    },
    {
      "anneeD": "2002",
      "anneeDebut": "27/09/2002",
      "anneeFin": "07/09/2007",
      "totalSieges" : "325",
      "chef" : "Jettou",
      "chefParty" : "Independent",
      "resultat": {
        "USFP": "50",
        "PI": "48",
        "PJD": "42",
        "RNI": "41",
        "MP": "27",
        "MNP": "18",
        "UC": "16",
        "PND": "12",
        "FFD": "12",
        "PPS": "11",
        "UD": "10",
        "MDS": "7",
        "PSD": "6",
        "AHD": "5",
        "ADL": "4",
        "PRD": "3",
        "GSU": "3",
        "PMD": "3",
        "FC": "2",
        "PED": "2",
        "PDI": "2",
        "CNI": "1",
        "AUTRE": "0",
        "Independent": "0"
      }
    },
    {
      "anneeD": "2007",
      "anneeDebut": "07/09/2007",
      "anneeFin": "25/11/2011",
      "totalSieges" : "325",
      "chef" : "Fassi",
      "chefParty" : "PI",
      "resultat": {
        "PI": "52",
        "PJD": "46",
        "MP": "41",
        "RNI": "39",
        "USFP": "38",
        "UC": "27",
        "PPS": "17",
        "Coalition": "14",
        "FFD": "9",
        "MDS": "9",
        "Alliance": "6",
        "PT": "5",
        "PED": "5",
        "PRE": "4",
        "PS": "2",
        "UMD": "2",
        "FC": "1",
        "ADL": "1",
        "ICD": "1",
        "PRV": "1",
        "AUTRE": "0",
        "Independent": "5"
      }
    },
    {
      "anneeD": "2011",
      "anneeDebut": "25/11/2011",
      "anneeFin": "07/10/2016",
      "totalSieges" : "395",
      "chef" : "Benkiran",
      "chefParty" : "PJD",
      "resultat": {
        "PJD": "107",
        "PI": "60",
        "RNI": "52",
        "PAM": "47",
        "USFP": "39",
        "MP": "32",
        "UC": "23",
        "PPS": "18",
        "PT": "4",
        "PRE": "2",
        "MDS": "2",
        "PEDD": "2",
        "AHD": "2",
        "FFD": "1",
        "PA": "1",
        "PUD": "1",
        "PLJS": "1",
        "PGV": "1",
        "AUTRE": "0",
        "Independent": "0"
      }
    },
    {
      "anneeD": "2016",
      "anneeDebut": "07/10/2016",
      "anneeFin": "30/12/2021",
      "totalSieges" : "395",
      "chef" : "Othmani ",
      "chefParty" : "",
      "resultat": {
        "PJD":"125",
        "PAM":"102",
        "PI":"46",
        "RNI":"37",
        "MP":"27",
        "USFP":"20",
        "UC":"19",
        "PPS":"12",
        "MDS":"3",
        "FGD":"2",
        "PUD":"1",
        "PGV":"1",
        "AUTRE": "0",
        "Independent": "0"
      }
    }
  ];


var mapColor = {
	"FDIC" : "#408080",
	"PND" : "#F0F0B4",
	"MNP" : "#FFFF80",
	"UD" : "#FFFF80",
	"UC" : "#FF8000", 
	"Independent":"#BBBBBB",
	"AUTRE":"#fff",
	"UNFP":"#8000FF",
	"USFP":"#8000FF",
	"PI":"#EE80FF",
	"MP":"#F0FF80",
	"PDI":"#FFCCFF",
	"PPS":"#8888FF",
	"PA":"#000000",
	"RNI":"#80D0FF",
	"PCS":"#C0CC66",
	"PADS":"#CC6666",
	"VD":"#FF0000",
	"MDS":"#80FF80",
	"FFD":"#808000",
	"PJD":"#0080FF",
	"PE":"#0080C0",
	"FC":"#99694C",
	"PRD":"#80FFFF",
	"CNI":"#B2C6FF",
	"PML":"#F0F0B4",
	"PRE":"#FF0080",
	"PSU":"#00FFFF",
	"PT":"#FF0000",
	"PRV":"#FFFF80",
	"PS":"#004000",
	"UMD":"#0080FF",
	"PEDD":"#408080",
	"PGV":"#00FF40",
	"PAM":"#0073e6",
	"Coalition":"#FFFFFF",
	"Alliance":"#FFFFFF"
}

var mapFullText = {
	"FDIC" : "Front pour la défense des institutions constitutionnelles - جبهة الدفاع عن المؤسسات الدستورية",
	"PND" : "Parti des néo-démocrates - حزب الديموقراطيون الجدد",
	"MNP" : "Mouvement national populaire - الحركة الوطنية الشعبية",
	"UD" : "Union démocratique - الاتحاد الديمقراطي",
	"UC" : "Union constitutionnelle - الاتحاد الدستوري", 
	"Independent":"Indépendants - الاحرار",
	"AUTRE":"Autres partis",
	"UNFP":"Union nationale des forces populaires - الاتحاد الوطني للقوات الشعبية",
	"USFP":"Union socialiste des forces populaires - الاتحاد الاشتراكي للقوات الشعبية",
	"PI":"Parti de l'istiqlal - حزب الاستقلال",
	"MP":"	Mouvement populaire - الحركة الشعبية",
	"PDI":"Parti démocratique de l'indépendance - حزب الشورى و الاستقلال",
	"PPS":"Parti du progrès et du socialisme - حزب التقدم والاشتراكية",
	"PA":"Parti de l'action - حزب العمل",
	"RNI":"Rassemblement national des indépendants - التجمع الوطني للاحرار",
	"PCS":"Parti du centre social - حزب الوسط الاجتماعي",
	"PADS":"Parti de l'avant-garde démocratique et socialiste - حزب الطليعة الديمقراطي الاشتراكي",
	"VD":"Parti Annahj Addimocrati - حزب النهج الديمقراطي",
	"MDS":"Mouvement démocratique et social - الحركة الديمقراطية الاجتماعية",
	"FFD":"Front des forces démocratiques - جبهة القوى الديمقراطية",
	"PJD":"Parti de la justice et du développement - حزب العدالة و التنمية",
	"PE":"Parti de l'espoir - حزب الامل",
	"FC":"Forces citoyennes - القوات المواطنة",
	"PRD":"Parti de la réforme et du développement - 	حزب الاصلاح و التنمية",
	"CNI":"Congrès national Ittihadi - المؤتمر الوطني الاتحادي",
	"PML":"Parti marocain libéral - الحزب المغربي الليبرالي",
	"PRE":"Parti du renouveau et de l'équité - حزب التجديد والانصاف",
	"PSU":"Parti socialiste unifié - الحزب الإشتراكي الموحد",
	"PT":"Parti travailliste - الحزب العمالي",
	"PRV":"Parti de la renaissance et de la vertu - حزب النهضة و الفضيلة",
	"PS":"Parti socialiste - الحزب الاشتراكي",
	"UMD":"Union marocaine pour la démocratie - الاتحاد المغربي للديمقراطية",
	"PEDD":"Parti de l'environnement et du développement durable - 	حزب البيئة و التنمية المستدامة",
	"PGV":"Parti de la gauche verte - حزب اليسار الأخضر ",
	"PAM":"Parti authenticité et modernité - حزب الأصالة و المعاصرة",
	"Coalition":"Coalition PND-Al Ahd",
	"Alliance":"Alliance de la gauche démocratique (PADS/CNI/PSU)"
}



var mapIcone = {
	"UNFP":"images/unfp.jpg",
	"PI":"images/pi.jpg",
	"MP":"images/mp.jpg",
	"PPS":"images/pps.jpg",
	"USFP":"images/usfp.jpg",
	"RNI":"images/rni.jpg",
	"UC ":"images/uc.jpg",
	"MDS":"images/mds.jpg",
	"FFD":"images/ffd.jpg",
	"PJD":"images/pjd.jpg",
	"PSU":"images/psu.jpg",
	"PAM":"images/pam.jpg",
	"UC":"images/uc.jpg",
}


var width;
var height;

var widthIconeParti = Math.min(width / 30, 50);


var minAutrePartie = 3;
var baseGroup;

var textSizeSmall;
var textSizeMed;
var textSizeBig;
var textSizeVeryBig;

var marginTop;
var marginBottom;
var marginRight;
var marginLeft;

function resize() {

	marginTop = 50;
	marginBottom = 20;
	marginRight = 20;
	marginLeft = 50;

	if (parseInt(d3.select("#chart1").style("width")) < 680) {
		marginTop = 40;
		marginBottom = 5;
		marginRight = 0;
		marginLeft = 0;
	}

	//d3.select("#widthPage").text(d3.select("#chart1").style("width"));

	//var height = parseInt(d3.select("#graph").style("width")) - marginTop - marginBottom;
	//var width = parseInt(d3.select("#graph").style("height")) - marginLeft - marginRight;

	width = parseInt(d3.select("#chart1").style("width")) - marginLeft - marginRight;
	height = parseInt(d3.select("#chart1").style("width")) / 2 - marginTop - marginBottom;

	widthIconeParti = Math.min(width / 30, 50);

	textSizeSmall = Math.max(width / 100, 4);
	textSizeMed = Math.max(width / 80, 6);
	textSizeBig = Math.max(width / 50, 8);
	textSizeVeryBig = Math.max(width / 30, 10);

	//console.log(width, textSizeSmall, textSizeMed, textSizeBig);

	yScaleLine = d3.scale.linear()
		.range([height, 0])
		.domain([0, 100]);


	var yScale = d3.scale.linear()
		.range([0, height])
		.domain([0, 100]);


	xScale = d3.time.scale()
		.domain([new Date(1963, 2, 1), new Date(2021, 12, 31)])
		.range([0, width]);



	var c20c = d3.scale.category20c();


	var yAxis = d3.svg.axis()
		.scale(yScale)
		.tickSize(Math.max(width / 1200, 6), 0, 0)
		.ticks(Math.max(width / 50, 2))
		.tickFormat(function (d) { return d + "%"; })
		.orient("left");


	var xBar = d3.svg.axis()
		.scale(xScale)
		//.tickSize(Math.max(height/1200, 6), 0, 0)
		.ticks(Math.max(height / 50, 2))
		.orient("bottom");

	var svg = d3.select('#chart1').select("svg#graph");
	var svgSelection;


	svg.selectAll("*").remove();

	svgSelection = svg
		.attr("width", width + marginLeft + marginRight)
		.attr("height", height + marginTop + marginBottom);

	if (baseGroup) baseGroup.remove();

	baseGroup = svgSelection
		.append("g")
		.attr("transform", "translate(" + marginLeft + "," + marginTop + ")");

	var newDataset = [];
	var countPartie = 0;
	var cumulePartie = 0;

	for (var i = 0; i < data.length; i++) {
		var adb = data[i].anneeDebut;
		var afn = data[i].anneeFin;
		var res = data[i].resultat;
		var totalSieges = data[i].totalSieges;
		countPartie = 0;
		cumulePartie = 0;
		otherPartie = 0;
		for (var key in res) {
			var currentPercent = res[key] / totalSieges * 100;
			if (key != 'AUTRE' && currentPercent > minAutrePartie) {
				countPartie++;

				var obj = {
					"partie": key,
					"anneeDebut": xScale(parseDate(adb)),
					"anneeFin": xScale(parseDate(afn)),
					"width": xScale(parseDate(afn)) - xScale(parseDate(adb)),
					"yStart": yScale(cumulePartie),
					"resultat": yScale(currentPercent),
					"currentPercent": parseInt(currentPercent) + "%",
					"text": key + " " + parseInt(currentPercent) + "%",
					"color": mapColor[key]
				};

				cumulePartie += parseFloat(res[key] / totalSieges * 100);
				newDataset.push(obj);
			} else {
				otherPartie += parseFloat(res[key]);
			}
		}

		if (otherPartie > 0) {
			var obj = {
				"partie": 'AUTRE',
				"anneeDebut": xScale(parseDate(adb)),
				"anneeFin": xScale(parseDate(afn)),
				"width": xScale(parseDate(afn)) - xScale(parseDate(adb)),
				"yStart": yScale(cumulePartie),
				"resultat": yScale(parseFloat(otherPartie / totalSieges * 100)),
				"currentPercent": parseInt(otherPartie / totalSieges * 100) + "%",
				"text": 'AUTRE' + " " + parseInt(otherPartie / totalSieges * 100) + "%",
				"color": mapColor['AUTRE']
			};

			newDataset.push(obj);
		}
	}


	var ggs = baseGroup.selectAll("g.tt").data(newDataset).enter().append("g");

	var rects = ggs
		.append("rect")
		.attr('class', function (d) { return "resultat " + d.partie })
		.attr("x", function (d) { return d.anneeDebut })
		.attr("y", function (d) { return d.yStart })
		.attr("width", function (d) { return d.width })
		.attr("height", function (d) { return d.resultat })
		.attr("fill", function (d) { return d.color })
		.on("mouseover", mouseOnPartis)
		.on("mouseout", mouseOutOfPartis);

	var ggss = baseGroup.selectAll("g.tt").data(data).enter().append("g");

	if (parseInt(d3.select("#chart1").style("width")) > 680) {
		baseGroup.append("g")
			.attr("class", "axis")
			.attr("fill", "#fff")
			.attr("top", "20")
			.attr("transform", "translate(0," + height + ")")
			.call(xBar);
		baseGroup.append("g")
			.attr("class", "axis")
			.attr("fill", "#fff")
			.call(yAxis);
		/*ggss
			.append("rect")
			.attr("x", function(d) {return xScale(parseDate(d.anneeDebut)) - textSizeSmall})
			.attr("y", 0)
			.attr("width", width/100)
			.attr("height", height)
			.attr("fill", function(d) {return d.color});*/
		/*
				ggss
					.append("text")
					.text("Mandat")
					.attr("x", function(d) {return xScale(parseDate(d.anneeDebut))})
					.attr("y", -50)
					.style({"font-size":textSizeBig,"z-index":"999999999"})
					.attr("dy", ".80em");
		*/
		ggss
			.append("text")
			.text(function (d) { return d.chef })
			.attr("x", function (d) { return xScale(parseDate(d.anneeDebut)) })
			.attr("y", -35)
			.attr("fill", "#fff")
			.style({ "font-size": "13", "z-index": "999999999" })
			.attr("dy", ".80em");

		ggss
			.append("text")
			.text(function (d) { return d.anneeDebut })
			.attr("x", function (d) { return xScale(parseDate(d.anneeDebut)) })
			.attr("y", -15)
			.attr("fill", "#fff")
			.style({ "font-size": "13", "z-index": "999999999" })
			.attr("dy", ".80em");

		var textsRes = ggs
			.append("text")
			.text(function (d) { return d.currentPercent })
			.attr('class', function (d) { return "resultat " + d.partie })
			.attr("x", function (d) { return (!mapIcone[d.partie] ? 0 : widthIconeParti) + + d.anneeDebut })
			.attr("y", function (d) { return d.yStart })
			.style({ "font-size": textSizeMed })
			.attr("dy", "1.6em")
			.on("mouseover", mouseOnPartis)
			.on("mouseout", mouseOutOfPartis);


		var texts = ggs
			.append("text")
			.text(function (d) { return d.partie })
			.attr('class', function (d) { return "resultat " + d.partie })
			.attr("x", function (d) { return (!mapIcone[d.partie] ? 0 : widthIconeParti) + d.anneeDebut })
			.attr("y", function (d) { return d.yStart })
			.style({ "font-size": textSizeMed })
			.attr("dy", ".80em")
			.on("mouseover", mouseOnPartis)
			.on("mouseout", mouseOutOfPartis);


		var imgs = ggs
			.append("image")
			.attr("xlink:href", function (d) { return mapIcone[d.partie]; })
			.attr('class', function (d) { return "resultat " + d.partie })
			.attr("x", function (d) { return d.anneeDebut })
			.attr("y", function (d) { return d.yStart })
			.attr("opacity", function (d) { return (d.partie == 'AUTRE' || !mapIcone[d.partie] ? '0' : '1') })
			.attr("height", widthIconeParti)
			.attr("width", widthIconeParti)
			.on("mouseover", mouseOnPartis)
			.on("mouseout", mouseOutOfPartis);

	} else {
		ggss
			.append("text")
			.text(function (d) { return formatDateCompact(parseDate(d.anneeDebut)) })
			.attr("x", function (d) { return xScale(parseDate(d.anneeDebut)) })
			.attr("y", -10)
			.style({ "font-size": textSizeBig, "z-index": "999999999" })
			.attr("dy", ".80em");

		/*
				ggss
					.append("text")
					.text("Mandat")
					.attr("x", function(d) {return xScale(parseDate(d.anneeDebut))})
					.attr("y", -40)
					.style({"font-size":textSizeBig,"z-index":"999999999"})
					.attr("dy", ".80em");
		*/
		ggss
			.append("text")
			.text(function (d) { return d.chef })
			.attr("x", function (d) { return xScale(parseDate(d.anneeDebut)) })
			.attr("y", -30)
			.style({ "font-size": textSizeBig, "z-index": "999999999" })
			.attr("dy", ".80em");



		var texts = ggs
			.append("text")
			.text(function (d) { return d.partie })
			.attr('class', function (d) { return "resultat " + d.partie })
			.attr("x", function (d) { return d.anneeDebut + width / 100 / 2 })
			.attr("y", function (d) { return d.yStart })
			.style({ "font-size": textSizeMed })
			.attr("dy", ".80em")
			.attr("opacity", function (d) { return (d.partie == 'AUTRE' || !mapIcone[d.partie] ? '1' : '0') })
			.on("mouseover", mouseOnPartis)
			.on("mouseout", mouseOutOfPartis);

		function decideIconeSize(d) {
			return (d.width > d.resultat) ? d.resultat : d.width;
		}
		var imgs = ggs
			.append("image")
			.attr("xlink:href", function (d) { return mapIcone[d.partie]; })
			.attr('class', function (d) { return "resultat " + d.partie })
			.attr("x", function (d) { return d.anneeDebut })
			.attr("y", function (d) { return d.yStart })
			.attr("opacity", function (d) { return (d.partie == 'AUTRE' || !mapIcone[d.partie] ? '0' : '1') })
			.attr("height", function (d) { return decideIconeSize(d) })
			.attr("width", function (d) { return decideIconeSize(d) })
			.on("mouseover", mouseOnPartis)
			.on("mouseout", mouseOutOfPartis);


	}

	d3.selectAll(".tick > text")
		.style("font-size", function (d) { return textSizeMed; });

	linePath = baseGroup.append("path");
}

var formatDate = d3.time.format("%d/%m/%Y");
var formatDateCompact = d3.time.format("%Y");

var parseDate = d3.time.format("%d/%m/%Y").parse;

var yScaleLine;
var linePath;
var xScale;
var lineChart = d3.svg.line()
	.x(function (d) { return xScale(parseDate(d.date)); })
	.y(function (d) { return yScaleLine(d.value); });

function mouseOutOfPartis(d, i) {
	d3.selectAll(".resultat").attr('opacity', '1')
		.attr("fill", function (d) { return mapColor[d.partie] });

	d3.selectAll('.lineParti').remove();
	d3.selectAll('.resPoint').remove();
	d3.selectAll('.focusParti').remove();
	d3.selectAll("text.resultat").attr('fill', null);

	linePath.attr('opacity', '0');
}

function mouseOnPartis(d, i) {
	d3.selectAll(".resultat")
		.attr('opacity', '0.2')
		.attr("fill", "gray")
	d3.selectAll("." + d.partie).attr('opacity', '1')
		.attr("fill", function (d) { return mapColor[d.partie] });

	d3.selectAll("text.resultat").attr('fill', null);

	if (d.partie != 'AUTRE') {
		var dataPartie = [];
		var currentRes = 0;
		data.forEach(function (element) {
			currentRes = (element.resultat[d.partie] ? element.resultat[d.partie] : 0) / element.totalSieges * 100;
			dataPartie.push(
				{
					"date": element.anneeDebut,
					"value": currentRes
				});

			var resPoint = baseGroup.append('g').attr('class', 'resPoint').attr("transform", "translate(" +
				xScale(parseDate(element.anneeDebut)) + "," +
				yScaleLine(currentRes) + ")");

			var circleX = resPoint.append("circle")
				.attr("r", 4.5);

			resPoint.append("text")
				.attr("transform", "translate(0,-10)")
				.attr("x", 9)
				.attr("dy", ".35em")
				.style({ "font-size": textSizeVeryBig, "z-index": "999999999" })
				.text(parseInt(currentRes) + '%');
		});

		var focusParti = baseGroup.append('g').attr('class', 'focusParti');
		focusParti
			.append("rect")
			.attr('width', width)
			.attr('height', marginTop)
			.attr('y', -marginTop);

		focusParti.append("image")
			.attr("xlink:href", mapIcone[d.partie])
			.attr('y', -marginTop)
			.attr("height", marginTop)
			.attr("width", marginTop);

		focusParti
			.append("text")
			.attr('class', 'lineParti')
			.text(d.partie + " : " + mapFullText[d.partie])
			.attr("x", marginTop)
			.attr('fill', 'white')
			.attr("y", -marginTop)
			.style({ "font-size": textSizeBig, "z-index": "999999999" })
			.attr("dy", ".80em");

		linePath
			.attr('opacity', '100')
			.attr("class", "line")
			.attr("stroke", "red")
			.attr("stroke-width", 2)
			.attr("fill", "none")
			.attr("d", lineChart(dataPartie));
	}
}

d3.select(window).on('resize', resize);

resize();
